var ImixsForms=(()=>{var p=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var b=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var y=(l,e)=>{for(var t in e)p(l,t,{get:e[t],enumerable:!0})},L=(l,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of b(e))!x.call(l,n)&&n!==t&&p(l,n,{get:()=>e[n],enumerable:!(r=v(e,n))||r.enumerable});return l};var X=l=>L(p({},"__esModule",{value:!0}),l);var I={};y(I,{ImixsFormController:()=>w});var u=class{constructor(e={}){let t=new URLSearchParams(window.location.search);this.config={baseUrl:e.baseUrl||"/api",credentials:e.credentials||{},workflowEndpoint:e.workflowEndpoint||"workflow/workitem",mockMode:e.mockMode||!1},this.workitemId=t.get("workitem"),this.workitemId||(this.config.modelversion=t.get("modelversion")||e.modelversion||"1.0.0",this.config.taskid=t.get("taskid")||e.taskid||"1000",this.config.eventid=t.get("eventid")||e.eventid||"10"),this.namespaces={xsi:"http://www.w3.org/2001/XMLSchema-instance",xs:"http://www.w3.org/2001/XMLSchema"},this.taskXML=null,this.eventsXML=null,this.workitemXML=null}async initialize(){this.workitemId?(await this.loadWorkitem(this.workitemId),this.config.modelversion=this.getItemValue("$modelversion",this.workitemXML)?.value,this.config.taskid=this.getItemValue("$taskid",this.workitemXML)?.value):this.workitemXML=this.createDocument(),await this.loadTaskDefinition(),await this.loadTaskEvents()}async loadTaskDefinition(){try{let e=this.getApiUrl(`model/${this.config.modelversion}/tasks/${this.config.taskid}?format=xml&items=name,dataobjects,workflow.abstract,documentation`),r=await(await this.fetchData(e)).text();return this.taskXML=this.parseXMLString(r),this.taskXML}catch(e){throw console.error("Error loading task definition:",e),e}}async loadTaskEvents(){try{let e=this.getApiUrl(`model/${this.config.modelversion}/tasks/${this.config.taskid}/events?format=xml&items=eventid,workflow.public,name`),r=await(await this.fetchData(e)).text();return this.eventsXML=this.parseXMLString(r),this.eventsXML}catch(e){throw console.error("Error loading task events:",e),e}}async loadWorkitem(e){try{let t=this.getApiUrl(`workflow/workitem/${e}`),n=await(await this.fetchData(t)).text(),i=this.parseXMLString(n).getElementsByTagName("document")[0],m=this.createDocument(),s=m.documentElement;for(let o of i.attributes)s.setAttribute(o.name,o.value);return s.innerHTML=i.innerHTML,this.workitemXML=m,m}catch(t){throw console.error("Error loading workitem:",t),t}}getFormDefinition(){let e=null;if(this.taskXML){let t=this.getItemValue("dataobjects",this.taskXML);t&&t[0]?.value==="Form"&&t[1]?.value&&(e=t[1].value,console.debug("Found form definition in task"),this.workitemXML&&(this.setItemValue("txtworkfloweditorcustomform",e,null,this.workitemXML),console.debug("Saved form definition to workitem")))}if(!e&&this.workitemXML){let t=this.getItemValue("txtworkfloweditorcustomform",this.workitemXML);t?.value&&(e=t.value,console.debug("Found form definition in workitem"))}return e?e.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&"):null}async fetchData(e,t={}){let r={Accept:"application/xml",...t.headers||{}};this.config.credentials.username&&(r.Authorization="Basic "+btoa(`${this.config.credentials.username}:${this.config.credentials.password}`));let n=await fetch(e,{...t,headers:r});if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return n}getApiUrl(e){return`${this.config.baseUrl}/${e}`}parseXMLString(e){return new DOMParser().parseFromString(e,"text/xml")}createDocument(){let e=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<document xmlns:xsi="`+this.namespaces.xsi+'" xmlns:xs="'+this.namespaces.xs+'"/>';return new DOMParser().parseFromString(e,"text/xml")}getItemValue(e,t=this.xmlDoc){let r=t.querySelector(`item[name="${e}"]`);if(!r)return null;let a=Array.from(r.getElementsByTagName("value")).map(i=>{let m=i.getAttribute("xsi:type");return m==="xmlItem"?Array.from(i.getElementsByTagName("value")).map(o=>({value:o.textContent,type:o.getAttribute("xsi:type")})):{value:i.textContent,type:m}}).flat();return a.length===1?a[0]:a}setItemValue(e,t,r=null,n=this.workitemXML){r||(r=this._determineXMLType(t));let a=n.querySelector(`item[name="${e}"]`);a?a.innerHTML="":(a=n.createElement("item"),a.setAttribute("name",e),n.documentElement.appendChild(a));let i=n.createElement("value");i.setAttribute("xsi:type",r),typeof t=="string"&&(t=t.trim()),i.textContent=t,a.appendChild(i)}_determineXMLType(e){return typeof e=="boolean"?"xs:boolean":typeof e=="number"?Number.isInteger(e)?"xs:int":"xs:double":"xs:string"}getDocuments(){return Array.from(this.xmlDoc.getElementsByTagName("document"))}toXMLString(e){return e?new XMLSerializer().serializeToString(e):(console.error("No XML document provided to toXMLString"),"")}};var h=class{constructor(e){this.dataManager=e}async getTaskDefinition(){try{return await this.dataManager.loadTaskDefinition()}catch(e){throw console.error("Error fetching task definition:",e),e}}async getTaskEvents(){try{return await this.dataManager.loadTaskEvents(),Array.from(this.dataManager.eventsXML.getElementsByTagName("document")).map(e=>({eventid:this.dataManager.getItemValue("eventid",e)?.value,name:this.dataManager.getItemValue("name",e)?.value,"workflow.public":this.dataManager.getItemValue("workflow.public",e)?.value==="true"})).filter(e=>e.name&&e["workflow.public"])}catch(e){throw console.error("Error fetching task events:",e),e}}getFormDefinition(){return this.dataManager.getFormDefinition()}};var g=class{constructor(e){this.dataManager=e}async parseFormDefinition(e){let r=this.dataManager.parseXMLString(e).getElementsByTagName("imixs-form-section"),n=[];for(let a of r){let i={label:a.getAttribute("label"),items:[]},m=a.getElementsByTagName("item");for(let s of m)i.items.push({name:s.getAttribute("name"),type:s.getAttribute("type"),label:s.getAttribute("label"),span:parseInt(s.getAttribute("span"))||12});n.push(i)}return n}renderForm(e,t,r=[]){let n=document.getElementById(t);if(!n){console.error(`Container element with id '${t}' not found`);return}let a=document.createElement("form");a.className="imixs-form",this._buildHeader(a),e.forEach(i=>{let m=document.createElement("div");m.className="imixs-form-section";let s=document.createElement("h3");s.textContent=i.label,m.appendChild(s);let o=document.createElement("div");o.className="imixs-form-items",i.items.forEach(c=>{let d=document.createElement("div");d.className=`imixs-form-item span-${c.span}`;let M=document.createElement("label");M.textContent=c.label,d.appendChild(M);let k=this._createInputElement(c),E=this.dataManager.getItemValue(c.name,this.dataManager.workitemXML)?.value;E&&(k.value=E),d.appendChild(k),o.appendChild(d)}),m.appendChild(o),a.appendChild(m)}),this._buildActionButtons(a,r),a.addEventListener("submit",i=>{let s=i.submitter?.dataset?.eventid||this.dataManager.config.eventid;this._handleSubmit(i,s)}),n.innerHTML="",n.appendChild(a)}_buildHeader(e){let t=this.dataManager.getItemValue("$workflowgroup",this.dataManager.workitemXML)?.value||"",r=this.dataManager.getItemValue("$workflowstatus",this.dataManager.workitemXML)?.value||"";r!=""&&(t=t+" - "+r);let n=this.dataManager.getItemValue("$workflowsummary",this.dataManager.workitemXML)?.value||"";t===""&&(t=this.dataManager.getItemValue("name",this.dataManager.taskXML)?.value||"");let a=document.createElement("h2");a.textContent=`${t}`,e.appendChild(a);let i=document.createElement("p");i.textContent=`${n}`,e.appendChild(i)}_buildActionButtons(e,t){let r=document.createElement("div");if(r.className="imixs-form-buttons",t.forEach(n=>{if(n&&n["workflow.public"]===!0&&n.name){let a=document.createElement("button");a.type="submit",a.className="imixs-submit-button",a.textContent=n.name,a.dataset.eventid=n.eventid,r.appendChild(a)}}),t.length===0){let n=document.createElement("button");n.type="submit",n.className="imixs-submit-button",n.textContent="Submit",n.dataset.eventid=this.dataManager.config.eventid,r.appendChild(n)}e.appendChild(r)}_createInputElement(e){let t;switch(e.type){case"html":t=document.createElement("textarea");break;case"currency":t=document.createElement("input"),t.type="number",t.step="0.01";break;case"text":default:t=document.createElement("input"),t.type="text"}return t.name=e.name,t.className="imixs-input",t}async _handleSubmit(e,t){e.preventDefault();let r=new FormData(e.target);try{this.dataManager.setItemValue("$modelversion",this.dataManager.config.modelversion,null,this.dataManager.workitemXML),this.dataManager.setItemValue("$taskid",this.dataManager.config.taskid,null,this.dataManager.workitemXML),this.dataManager.setItemValue("$eventid",t,null,this.dataManager.workitemXML);for(let[o,c]of r.entries())this.dataManager.setItemValue(o,c,null,this.dataManager.workitemXML);if(this.dataManager.config.mockMode){console.log("Form Data:",Object.fromEntries(r)),console.log("Event ID:",t);let o=this.dataManager.toXMLString(this.dataManager.workitemXML);console.log("XML Document:",o),this._triggerEvent("formSubmitSuccess",{formData:Object.fromEntries(r),xmlDocument:o,eventId:t});return}let n=this.dataManager.getApiUrl(this.dataManager.config.workflowEndpoint),i=await(await this.dataManager.fetchData(n,{method:"POST",headers:{"Content-Type":"application/xml"},body:this.dataManager.toXMLString(this.dataManager.workitemXML)})).text(),m=this.dataManager.parseXMLString(i),s=this.dataManager.getItemValue("$uniqueid",m)?.value;if(s){let o=new URL(window.location.href);o.searchParams.set("workitem",s),o.searchParams.delete("eventid"),o.searchParams.delete("modelversion"),o.searchParams.delete("taskid"),this._triggerEvent("formSubmitSuccess",{result:i,uniqueId:s,redirectUrl:o.toString()}),window.location.href=o.toString()}else console.error("No uniqueid found in response"),this._triggerEvent("formSubmitError",{error:new Error("No uniqueid found in response")})}catch(n){console.error("Submit error:",n),this._triggerEvent("formSubmitError",{error:n})}}_triggerEvent(e,t){let r=new CustomEvent(e,{detail:t});document.dispatchEvent(r)}};var f=class{constructor(e={}){this.containerId=e.containerId||"error-container",this._ensureContainer()}_ensureContainer(){if(!document.getElementById(this.containerId)){let e=document.createElement("div");e.id=this.containerId,e.className="error-container",document.body.insertBefore(e,document.body.firstChild)}}showError(e,t={}){let r=document.getElementById(this.containerId),n=document.createElement("div");n.className=`error-box ${t.type||"error"}`;let a=document.createElement("div");a.className="error-header";let i=document.createElement("span"),m=t.type==="warning"?"Warning":t.type==="info"?"Info":"Error";i.textContent=m,a.appendChild(i);let s=document.createElement("button");s.innerHTML="&times;",s.onclick=()=>n.remove(),a.appendChild(s),n.appendChild(a);let o=document.createElement("div");return o.className="error-message",o.textContent=e,n.appendChild(o),r.appendChild(n),t.timeout&&setTimeout(()=>{n.parentNode&&n.remove()},t.timeout),n}showWarning(e,t={}){return this.showError(e,{...t,type:"warning"})}showInfo(e,t={}){return this.showError(e,{...t,type:"info"})}clearAll(){let e=document.getElementById(this.containerId);e.innerHTML=""}handleError(e){let t;e.name==="NetworkError"||e.message.includes("Failed to fetch")?t="Network error: Unable to connect to the server. Please check your connection.":e.message.includes("No form definition found")?t="No form definition found for the specified task. Please check model version and task ID.":t=`An error occurred: ${e.message}`,this.showError(t)}};var w=class{constructor(e,t={}){this.containerId=e,document.addEventListener("DOMContentLoaded",()=>this.init(t))}async init(e){try{this.errorManager=new f,this.dataManager=new u(e),this.modelManager=new h(this.dataManager),this.formManager=new g(this.dataManager),this._setupEventHandlers(),await this._initializeForm()}catch(t){this.errorManager.handleError(t)}}_setupEventHandlers(){document.addEventListener("formSubmitSuccess",e=>{console.log("Form data:",e.detail),this.errorManager.showInfo("Form submitted successfully!",{timeout:3e3})}),document.addEventListener("formSubmitError",e=>{this.errorManager.handleError(e.detail.error)})}async _initializeForm(){await this.dataManager.initialize();let e=this.modelManager.getFormDefinition();if(!e)throw new Error("No form definition found in task or workitem data");let t=await this.modelManager.getTaskEvents(),r=await this.formManager.parseFormDefinition(e);this.formManager.renderForm(r,this.containerId,t)}};return X(I);})();
//# sourceMappingURL=imixs-forms.min.js.map

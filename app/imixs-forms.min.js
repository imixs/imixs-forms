var ImixsForms=(()=>{var L=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var D=Object.prototype.hasOwnProperty;var T=(c,t)=>{for(var e in t)L(c,e,{get:t[e],enumerable:!0})},N=(c,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of S(t))!D.call(c,r)&&r!==e&&L(c,r,{get:()=>t[r],enumerable:!(n=X(t,r))||n.enumerable});return c};var $=c=>N(L({},"__esModule",{value:!0}),c);var A={};T(A,{ImixsFormController:()=>C});var w=class{constructor(t={}){let e=new URLSearchParams(window.location.search);this.config={baseUrl:t.baseUrl||"/api",credentials:t.credentials||{},workflowEndpoint:t.workflowEndpoint||"workflow/workitem",mockMode:t.mockMode||!1},this.workitemId=e.get("workitem"),this.workitemId||(this.config.modelversion=e.get("modelversion")||t.modelversion||"1.0.0",this.config.taskid=e.get("taskid")||t.taskid||"1000",this.config.eventid=e.get("eventid")||t.eventid||"10"),this.namespaces={xsi:"http://www.w3.org/2001/XMLSchema-instance",xs:"http://www.w3.org/2001/XMLSchema"},this.taskXML=null,this.eventsXML=null,this.workitemXML=null,this.worklistXML=null}async initialize(){this.workitemId?(await this.loadWorkitem(this.workitemId),this.config.modelversion=this.getItemValue("$modelversion",this.workitemXML)?.value,this.config.taskid=this.getItemValue("$taskid",this.workitemXML)?.value):this.workitemXML=this.createDocument(),await this.loadTaskDefinition(),await this.loadTaskEvents()}async loadTaskDefinition(){try{let t=this.getApiUrl(`model/${this.config.modelversion}/tasks/${this.config.taskid}?format=xml&items=name,dataobjects,workflow.abstract,documentation`),n=await(await this.fetchData(t)).text();return this.taskXML=this.parseXMLString(n),this.taskXML}catch(t){throw console.error("Error loading task definition:",t),t}}async loadTaskEvents(){try{let t=this.getApiUrl(`model/${this.config.modelversion}/tasks/${this.config.taskid}/events?format=xml&items=eventid,workflow.public,name`),n=await(await this.fetchData(t)).text();return this.eventsXML=this.parseXMLString(n),this.eventsXML}catch(t){throw console.error("Error loading task events:",t),t}}async loadWorkitem(t){try{let e=this.getApiUrl(`workflow/workitem/${t}`),r=await(await this.fetchData(e)).text(),o=this.parseXMLString(r).getElementsByTagName("document")[0],s=this.createDocument(),i=s.documentElement;for(let l of o.attributes)i.setAttribute(l.name,l.value);return i.innerHTML=o.innerHTML,this.workitemXML=s,s}catch(e){throw console.error("Error loading workitem:",e),e}}async loadWorklist(){try{let t=this.getApiUrl("workflow/tasklist/creator/null"),n=await(await this.fetchData(t)).text();return this.worklistXML=this.parseXMLString(n),this.worklistXML}catch(t){throw console.error("Error loading worklist:",t),t}}getFormDefinition(){let t=null;if(this.taskXML){let e=this.getItemValue("dataobjects",this.taskXML);e&&e[0]?.value==="Form"&&e[1]?.value&&(t=e[1].value,console.debug("Found form definition in task"),this.workitemXML&&(this.setItemValue("txtworkfloweditorcustomform",t,null,this.workitemXML),console.debug("Saved form definition to workitem")))}if(!t&&this.workitemXML){let e=this.getItemValue("txtworkfloweditorcustomform",this.workitemXML);e?.value&&(t=e.value,console.debug("Found form definition in workitem"))}return t?t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&"):null}async fetchData(t,e={}){let n={Accept:"application/xml",...e.headers||{}};this.config.credentials.username&&(n.Authorization="Basic "+btoa(`${this.config.credentials.username}:${this.config.credentials.password}`));let r=await fetch(t,{...e,headers:n});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r}getApiUrl(t){return`${this.config.baseUrl}/${t}`}parseXMLString(t){return new DOMParser().parseFromString(t,"text/xml")}createDocument(){let t=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<document xmlns:xsi="`+this.namespaces.xsi+'" xmlns:xs="'+this.namespaces.xs+'"/>';return new DOMParser().parseFromString(t,"text/xml")}getItemValue(t,e=this.xmlDoc){let n=e.querySelector(`item[name="${t}"]`);if(!n)return null;let a=Array.from(n.getElementsByTagName("value")).map(o=>{let s=o.getAttribute("xsi:type");return s==="xmlItem"?Array.from(o.getElementsByTagName("value")).map(l=>({value:l.textContent,type:l.getAttribute("xsi:type")})):{value:o.textContent,type:s}}).flat();return a.length===1?a[0]:a}setItemValue(t,e,n=null,r=this.workitemXML){n||(n=this._determineXMLType(e));let a=r.querySelector(`item[name="${t}"]`);a?a.innerHTML="":(a=r.createElement("item"),a.setAttribute("name",t),r.documentElement.appendChild(a));let o=r.createElement("value");o.setAttribute("xsi:type",n),typeof e=="string"&&(e=e.trim()),o.textContent=e,a.appendChild(o)}_determineXMLType(t){return typeof t=="boolean"?"xs:boolean":typeof t=="number"?Number.isInteger(t)?"xs:int":"xs:double":"xs:string"}getDocuments(){return Array.from(this.xmlDoc.getElementsByTagName("document"))}toXMLString(t){return t?new XMLSerializer().serializeToString(t):(console.error("No XML document provided to toXMLString"),"")}};var p=class{constructor(t){this.dataManager=t}async getTaskDefinition(){try{return await this.dataManager.loadTaskDefinition()}catch(t){throw console.error("Error fetching task definition:",t),t}}async getTaskEvents(){try{return await this.dataManager.loadTaskEvents(),Array.from(this.dataManager.eventsXML.getElementsByTagName("document")).map(t=>({eventid:this.dataManager.getItemValue("eventid",t)?.value,name:this.dataManager.getItemValue("name",t)?.value,"workflow.public":this.dataManager.getItemValue("workflow.public",t)?.value==="true"})).filter(t=>t.name&&t["workflow.public"])}catch(t){throw console.error("Error fetching task events:",t),t}}getFormDefinition(){return this.dataManager.getFormDefinition()}};var k=class{constructor(t){this.dataManager=t}async parseFormDefinition(t){let n=this.dataManager.parseXMLString(t).getElementsByTagName("imixs-form-section"),r=[];for(let a of n){let o={label:a.getAttribute("label"),items:[]},s=a.getElementsByTagName("item");for(let i of s)o.items.push({name:i.getAttribute("name"),type:i.getAttribute("type"),label:i.getAttribute("label"),span:parseInt(i.getAttribute("span"))||12});r.push(o)}return r}renderForm(t,e,n=[]){let r=document.getElementById(e);if(!r){console.error(`Container element with id '${e}' not found`);return}let a=document.createElement("form");a.className="imixs-form",this._buildHeader(a),t.forEach(o=>{let s=document.createElement("div");s.className="imixs-form-section";let i=document.createElement("h3");i.textContent=o.label,s.appendChild(i);let l=document.createElement("div");l.className="imixs-form-items",o.items.forEach(d=>{let u=document.createElement("div");u.className=`imixs-form-item span-${d.span}`;let h=document.createElement("label");h.textContent=d.label,u.appendChild(h);let g=this._createInputElement(d),m=this.dataManager.getItemValue(d.name,this.dataManager.workitemXML)?.value;m&&(g.value=m),u.appendChild(g),l.appendChild(u)}),s.appendChild(l),a.appendChild(s)}),this._buildActionButtons(a,n),a.addEventListener("submit",o=>{let i=o.submitter?.dataset?.eventid||this.dataManager.config.eventid;this._handleSubmit(o,i)}),r.innerHTML="",r.appendChild(a)}_buildHeader(t){let e=this.dataManager.getItemValue("$workflowgroup",this.dataManager.workitemXML)?.value||"",n=this.dataManager.getItemValue("$workflowstatus",this.dataManager.workitemXML)?.value||"";n!=""&&(e=e+" - "+n);let r=this.dataManager.getItemValue("$workflowsummary",this.dataManager.workitemXML)?.value||"";e===""&&(e=this.dataManager.getItemValue("name",this.dataManager.taskXML)?.value||"");let a=document.createElement("h2");a.textContent=`${e}`,t.appendChild(a);let o=document.createElement("p");o.textContent=`${r}`,t.appendChild(o)}_buildActionButtons(t,e){let n=document.createElement("div");n.className="imixs-form-buttons",e.forEach(r=>{if(r&&r["workflow.public"]===!0&&r.name){let a=document.createElement("button");a.type="submit",a.className="imixs-submit-button",a.textContent=r.name,a.dataset.eventid=r.eventid,n.appendChild(a)}}),e.length===0&&console.log("No Action events found"),t.appendChild(n)}_createInputElement(t){let e;switch(t.type){case"html":e=document.createElement("textarea");break;case"currency":e=document.createElement("input"),e.type="number",e.step="0.01";break;case"text":default:e=document.createElement("input"),e.type="text"}return e.name=t.name,e.className="imixs-input",e}async _handleSubmit(t,e){t.preventDefault();let n=new FormData(t.target);try{this.dataManager.setItemValue("$modelversion",this.dataManager.config.modelversion,null,this.dataManager.workitemXML),this.dataManager.setItemValue("$taskid",this.dataManager.config.taskid,null,this.dataManager.workitemXML),this.dataManager.setItemValue("$eventid",e,null,this.dataManager.workitemXML);for(let[l,d]of n.entries())this.dataManager.setItemValue(l,d,null,this.dataManager.workitemXML);if(this.dataManager.config.mockMode){console.log("Form Data:",Object.fromEntries(n)),console.log("Event ID:",e);let l=this.dataManager.toXMLString(this.dataManager.workitemXML);console.log("XML Document:",l),this._triggerEvent("formSubmitSuccess",{formData:Object.fromEntries(n),xmlDocument:l,eventId:e});return}let r=this.dataManager.getApiUrl(this.dataManager.config.workflowEndpoint),o=await(await this.dataManager.fetchData(r,{method:"POST",headers:{"Content-Type":"application/xml"},body:this.dataManager.toXMLString(this.dataManager.workitemXML)})).text(),s=this.dataManager.parseXMLString(o),i=this.dataManager.getItemValue("$uniqueid",s)?.value;if(i){let l=new URL(window.location.href);l.searchParams.set("workitem",i),l.searchParams.delete("eventid"),l.searchParams.delete("modelversion"),l.searchParams.delete("taskid"),this._triggerEvent("formSubmitSuccess",{result:o,uniqueId:i,redirectUrl:l.toString()}),window.location.href=l.toString()}else console.error("No uniqueid found in response"),this._triggerEvent("formSubmitError",{error:new Error("No uniqueid found in response")})}catch(r){console.error("Submit error:",r),this._triggerEvent("formSubmitError",{error:r})}}_triggerEvent(t,e){let n=new CustomEvent(t,{detail:e});document.dispatchEvent(n)}};var M=class{constructor(t={}){this.containerId=t.containerId||"error-container",this._ensureContainer()}_ensureContainer(){if(!document.getElementById(this.containerId)){let t=document.createElement("div");t.id=this.containerId,t.className="error-container",document.body.insertBefore(t,document.body.firstChild)}}showError(t,e={}){let n=document.getElementById(this.containerId),r=document.createElement("div");r.className=`error-box ${e.type||"error"}`;let a=document.createElement("div");a.className="error-header";let o=document.createElement("span"),s=e.type==="warning"?"Warning":e.type==="info"?"Info":"Error";o.textContent=s,a.appendChild(o);let i=document.createElement("button");i.innerHTML="&times;",i.onclick=()=>r.remove(),a.appendChild(i),r.appendChild(a);let l=document.createElement("div");return l.className="error-message",l.textContent=t,r.appendChild(l),n.appendChild(r),e.timeout&&setTimeout(()=>{r.parentNode&&r.remove()},e.timeout),r}showWarning(t,e={}){return this.showError(t,{...e,type:"warning"})}showInfo(t,e={}){return this.showError(t,{...e,type:"info"})}clearAll(){let t=document.getElementById(this.containerId);t.innerHTML=""}handleError(t){let e;t.name==="NetworkError"||t.message.includes("Failed to fetch")?e="Network error: Unable to connect to the server. Please check your connection.":t.message.includes("No form definition found")?e="No form definition found for the specified task. Please check model version and task ID.":e=`An error occurred: ${t.message}`,this.showError(e)}};var E=class{constructor(t,e){this.dataManager=t,this.containerId=e}async renderWorklist(){try{await this.dataManager.loadWorklist();let t=document.getElementById(this.containerId);if(!t){console.error(`Container element with id '${this.containerId}' not found`);return}let e=document.createElement("table");e.className="imixs-worklist";let n=document.createElement("thead"),r=document.createElement("tr");["Workflow","Summary","Last Update","Status","Action"].forEach(s=>{let i=document.createElement("th");i.textContent=s,r.appendChild(i)}),n.appendChild(r),e.appendChild(n);let a=document.createElement("tbody"),o=Array.from(this.dataManager.worklistXML.getElementsByTagName("document"));if(o.length===0){let s=document.createElement("tr"),i=document.createElement("td");i.colSpan=4,i.textContent="No tasks found",i.className="empty-worklist",s.appendChild(i),a.appendChild(s)}else o.forEach(s=>{let i=this.dataManager.getItemValue("$workflowgroup",s)?.value||"-",l=this.dataManager.getItemValue("$workflowstatus",s)?.value||"-",d=this.dataManager.getItemValue("$workflowsummary",s)?.value||"-",u=this.dataManager.getItemValue("$modified",s)?.value||"-",h=this.dataManager.getItemValue("$uniqueid",s)?.value,g=u!=="-"?this._formatDate(u):"-",m=document.createElement("tr"),y=document.createElement("td");y.textContent=i,y.style="text-align:center",m.appendChild(y);let I=document.createElement("td");I.textContent=d,m.appendChild(I);let v=document.createElement("td");v.textContent=g,v.style="text-align:center",m.appendChild(v);let x=document.createElement("td");x.textContent=l,x.style="text-align:center",m.appendChild(x);let b=document.createElement("td");if(h){let f=document.createElement("button");f.textContent="Open",f.className="imixs-worklist-open-button",f.onclick=()=>this._openWorkitem(h),b.appendChild(f)}b.style="text-align:center",m.appendChild(b),a.appendChild(m)});e.appendChild(a),t.innerHTML="",t.appendChild(e)}catch(t){throw console.error("Error rendering worklist:",t),t}}_formatDate(t){try{let e=new Date(t);return e.toLocaleDateString()+" "+e.toLocaleTimeString()}catch{return t}}_openWorkitem(t){let e=new URL(window.location.href);e.searchParams.set("workitem",t),e.searchParams.delete("showWorklist"),e.searchParams.delete("modelversion"),e.searchParams.delete("taskid"),window.location.href=e.toString()}};var C=class{constructor(t,e,n={}){this.containerId=t,this.worklistContainerId=e||null,document.addEventListener("DOMContentLoaded",()=>this.init(n))}async init(t){try{this.errorManager=new M,this.dataManager=new w(t),this.modelManager=new p(this.dataManager),this.formManager=new k(this.dataManager),this.worklistContainerId&&(this.worklistManager=new E(this.dataManager,this.worklistContainerId)),this._setupEventHandlers();let e=new URLSearchParams(window.location.search);e.get("showWorklist")==="true"&&this.worklistManager?await this.worklistManager.renderWorklist():e.get("workitem")||e.get("taskid")?await this._initializeForm():this.worklistManager&&await this.worklistManager.renderWorklist()}catch(e){this.errorManager.handleError(e)}}_setupEventHandlers(){document.addEventListener("formSubmitSuccess",n=>{console.log("Form data:",n.detail),this.errorManager.showInfo("Form submitted successfully!",{timeout:3e3})}),document.addEventListener("formSubmitError",n=>{this.errorManager.handleError(n.detail.error)});let t=document.getElementById("show-worklist-button");t&&this.worklistManager&&t.addEventListener("click",async()=>{try{await this.worklistManager.renderWorklist();let n=document.getElementById("form-container");n&&(n.style.display="none");let r=new URL(window.location.href);r.searchParams.set("showWorklist","true"),r.searchParams.delete("workitem"),r.searchParams.delete("taskid"),window.history.pushState({},"",r)}catch(n){this.errorManager.handleError(n)}});let e=document.getElementById("new-task-button");e&&e.addEventListener("click",()=>{let n=document.getElementById("form-container");n&&(n.style.display="block");let r=new URL(window.location.href);r.searchParams.delete("workitem"),r.searchParams.delete("showWorklist"),r.searchParams.set("taskid","1000"),r.searchParams.set("modelversion","ticket-en-1.0"),window.location.href=r.toString()})}async _initializeForm(){await this.dataManager.initialize();let t=this.modelManager.getFormDefinition();if(!t)throw new Error("No form definition found in task or workitem data");let e=await this.modelManager.getTaskEvents(),n=await this.formManager.parseFormDefinition(t);this.formManager.renderForm(n,this.containerId,e)}async showWorklist(){return this.worklistManager?(await this.worklistManager.renderWorklist(),!0):!1}};return $(A);})();
